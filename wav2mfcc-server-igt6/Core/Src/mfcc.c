/**
 * @file mfcc.c
 * @author pansamic (pansamic@foxmail.com)
 * @brief This file is used to calculate MFCC feature of one frame of audio data.
 *     User should call audio_get_mfcc() to each of frame and gather up all the
 *     MFCC data. 
 * @version 0.1
 * @date 2023-11-10
 * 
 * @copyright Copyright (c) 2023
 * 
 */

#define __FPU_PRESENT 1 // avoid compiler error
/*************************************************************/
/*                        INCLUDE                            */
/*************************************************************/
#include <string.h>
#include <arm_math.h>
#include <mfcc.h>
/*************************************************************/
/*                         DEFINE                            */
/*************************************************************/



/*************************************************************/
/*                        VARIABLE                           */
/*************************************************************/
float hamming_window[FRAME_SIZE] = {
0.076720, 0.076729, 0.076755, 0.076798, 0.076859, 0.076938, 0.077033, 0.077147, 0.077277, 0.077425, 0.077590, 0.077773, 0.077973, 0.078191, 0.078426, 0.078678, 0.078947, 
0.079234, 0.079538, 0.079860, 0.080199, 0.080555, 0.080928, 0.081318, 0.081726, 0.082151, 0.082594, 0.083053, 0.083530, 0.084023, 0.084534, 0.085062, 0.085608, 
0.086170, 0.086749, 0.087345, 0.087959, 0.088589, 0.089236, 0.089901, 0.090582, 0.091280, 0.091995, 0.092726, 0.093475, 0.094240, 0.095022, 0.095821, 0.096637, 
0.097469, 0.098318, 0.099183, 0.100065, 0.100964, 0.101878, 0.102810, 0.103758, 0.104722, 0.105703, 0.106700, 0.107713, 0.108743, 0.109788, 0.110850, 0.111928, 
0.113022, 0.114132, 0.115258, 0.116401, 0.117559, 0.118732, 0.119922, 0.121128, 0.122349, 0.123586, 0.124838, 0.126107, 0.127390, 0.128690, 0.130004, 0.131334, 
0.132680, 0.134041, 0.135417, 0.136808, 0.138214, 0.139636, 0.141072, 0.142523, 0.143990, 0.145471, 0.146967, 0.148478, 0.150004, 0.151544, 0.153099, 0.154668, 
0.156252, 0.157850, 0.159463, 0.161090, 0.162731, 0.164386, 0.166055, 0.167739, 0.169436, 0.171148, 0.172873, 0.174612, 0.176365, 0.178131, 0.179911, 0.181704, 
0.183511, 0.185332, 0.187165, 0.189012, 0.190872, 0.192745, 0.194631, 0.196531, 0.198443, 0.200367, 0.202305, 0.204255, 0.206218, 0.208194, 0.210182, 0.212182, 
0.214195, 0.216219, 0.218256, 0.220305, 0.222366, 0.224439, 0.226524, 0.228621, 0.230729, 0.232849, 0.234980, 0.237123, 0.239277, 0.241443, 0.243619, 0.245807, 
0.248006, 0.250216, 0.252436, 0.254668, 0.256910, 0.259163, 0.261426, 0.263700, 0.265984, 0.268278, 0.270583, 0.272897, 0.275222, 0.277556, 0.279901, 0.282255, 
0.284619, 0.286992, 0.289375, 0.291767, 0.294169, 0.296580, 0.299000, 0.301429, 0.303867, 0.306313, 0.308769, 0.311233, 0.313706, 0.316187, 0.318676, 0.321174, 
0.323680, 0.326195, 0.328717, 0.331247, 0.333785, 0.336330, 0.338883, 0.341444, 0.344012, 0.346588, 0.349171, 0.351760, 0.354357, 0.356961, 0.359572, 0.362189, 
0.364813, 0.367444, 0.370081, 0.372725, 0.375374, 0.378030, 0.380692, 0.383360, 0.386033, 0.388713, 0.391398, 0.394088, 0.396784, 0.399486, 0.402192, 0.404904, 
0.407621, 0.410343, 0.413069, 0.415801, 0.418536, 0.421277, 0.424022, 0.426771, 0.429524, 0.432282, 0.435043, 0.437809, 0.440578, 0.443351, 0.446127, 0.448907, 
0.451690, 0.454477, 0.457266, 0.460059, 0.462855, 0.465654, 0.468455, 0.471259, 0.474065, 0.476874, 0.479686, 0.482499, 0.485315, 0.488132, 0.490951, 0.493773, 
0.496596, 0.499420, 0.502246, 0.505074, 0.507902, 0.510732, 0.513563, 0.516394, 0.519227, 0.522060, 0.524894, 0.527728, 0.530563, 0.533398, 0.536233, 0.539069, 
0.541904, 0.544739, 0.547574, 0.550409, 0.553243, 0.556077, 0.558910, 0.561742, 0.564573, 0.567403, 0.570232, 0.573060, 0.575887, 0.578712, 0.581536, 0.584358, 
0.587178, 0.589997, 0.592814, 0.595628, 0.598440, 0.601251, 0.604058, 0.606863, 0.609666, 0.612466, 0.615263, 0.618058, 0.620849, 0.623637, 0.626422, 0.629203, 
0.631982, 0.634756, 0.637527, 0.640295, 0.643058, 0.645818, 0.648573, 0.651324, 0.654071, 0.656814, 0.659552, 0.662286, 0.665015, 0.667739, 0.670458, 0.673172, 
0.675882, 0.678586, 0.681284, 0.683978, 0.686665, 0.689348, 0.692024, 0.694695, 0.697360, 0.700019, 0.702671, 0.705318, 0.707958, 0.710592, 0.713220, 0.715840, 
0.718454, 0.721062, 0.723662, 0.726255, 0.728842, 0.731421, 0.733993, 0.736557, 0.739114, 0.741664, 0.744205, 0.746739, 0.749265, 0.751784, 0.754294, 0.756796, 
0.759289, 0.761775, 0.764252, 0.766720, 0.769180, 0.771631, 0.774073, 0.776507, 0.778931, 0.781347, 0.783753, 0.786150, 0.788538, 0.790916, 0.793284, 0.795643, 
0.797993, 0.800332, 0.802662, 0.804981, 0.807291, 0.809590, 0.811880, 0.814159, 0.816427, 0.818685, 0.820933, 0.823169, 0.825395, 0.827611, 0.829815, 0.832008, 
0.834190, 0.836362, 0.838521, 0.840670, 0.842807, 0.844933, 0.847047, 0.849149, 0.851240, 0.853319, 0.855386, 0.857441, 0.859484, 0.861515, 0.863533, 0.865540, 
0.867534, 0.869516, 0.871485, 0.873441, 0.875385, 0.877317, 0.879235, 0.881141, 0.883033, 0.884913, 0.886780, 0.888633, 0.890473, 0.892300, 0.894114, 0.895914, 
0.897701, 0.899474, 0.901234, 0.902979, 0.904712, 0.906430, 0.908134, 0.909825, 0.911501, 0.913163, 0.914812, 0.916446, 0.918065, 0.919671, 0.921262, 0.922838, 
0.924401, 0.925948, 0.927481, 0.928999, 0.930503, 0.931991, 0.933465, 0.934924, 0.936368, 0.937797, 0.939211, 0.940610, 0.941993, 0.943362, 0.944715, 0.946053, 
0.947375, 0.948682, 0.949973, 0.951249, 0.952510, 0.953755, 0.954984, 0.956197, 0.957395, 0.958577, 0.959742, 0.960893, 0.962027, 0.963145, 0.964247, 0.965333, 
0.966403, 0.967457, 0.968494, 0.969516, 0.970521, 0.971510, 0.972482, 0.973438, 0.974378, 0.975301, 0.976208, 0.977098, 0.977972, 0.978829, 0.979669, 0.980493, 
0.981300, 0.982091, 0.982864, 0.983621, 0.984362, 0.985085, 0.985791, 0.986481, 0.987154, 0.987809, 0.988448, 0.989070, 0.989675, 0.990263, 0.990833, 0.991387, 
0.991924, 0.992443, 0.992946, 0.993431, 0.993899, 0.994350, 0.994783, 0.995200, 0.995599, 0.995981, 0.996346, 0.996693, 0.997023, 0.997336, 0.997631, 0.997910, 
0.998170, 0.998414, 0.998640, 0.998849, 0.999040, 0.999214, 0.999371, 0.999510, 0.999632, 0.999737, 0.999824, 0.999893, 0.999946, 0.999980, 0.999998, 0.999998, 
0.999980, 0.999946, 0.999893, 0.999824, 0.999737, 0.999632, 0.999510, 0.999371, 0.999214, 0.999040, 0.998849, 0.998640, 0.998414, 0.998170, 0.997910, 0.997631, 
0.997336, 0.997023, 0.996693, 0.996346, 0.995981, 0.995599, 0.995200, 0.994783, 0.994350, 0.993899, 0.993431, 0.992946, 0.992443, 0.991924, 0.991387, 0.990833, 
0.990263, 0.989675, 0.989070, 0.988448, 0.987809, 0.987154, 0.986481, 0.985791, 0.985085, 0.984362, 0.983621, 0.982864, 0.982091, 0.981300, 0.980493, 0.979669, 
0.978829, 0.977972, 0.977098, 0.976208, 0.975301, 0.974378, 0.973438, 0.972482, 0.971510, 0.970521, 0.969516, 0.968494, 0.967457, 0.966403, 0.965333, 0.964247, 
0.963145, 0.962027, 0.960892, 0.959742, 0.958576, 0.957395, 0.956197, 0.954984, 0.953755, 0.952510, 0.951249, 0.949973, 0.948682, 0.947375, 0.946053, 0.944715, 
0.943362, 0.941993, 0.940610, 0.939211, 0.937797, 0.936368, 0.934924, 0.933465, 0.931991, 0.930503, 0.928999, 0.927481, 0.925948, 0.924400, 0.922838, 0.921262, 
0.919671, 0.918065, 0.916446, 0.914812, 0.913163, 0.911501, 0.909824, 0.908134, 0.906430, 0.904711, 0.902979, 0.901233, 0.899474, 0.897701, 0.895914, 0.894114, 
0.892300, 0.890473, 0.888633, 0.886780, 0.884913, 0.883033, 0.881141, 0.879235, 0.877316, 0.875385, 0.873441, 0.871485, 0.869516, 0.867534, 0.865540, 0.863533, 
0.861515, 0.859484, 0.857441, 0.855386, 0.853319, 0.851240, 0.849149, 0.847047, 0.844933, 0.842807, 0.840670, 0.838521, 0.836362, 0.834191, 0.832008, 0.829815, 
0.827611, 0.825395, 0.823169, 0.820933, 0.818685, 0.816427, 0.814159, 0.811880, 0.809590, 0.807291, 0.804981, 0.802662, 0.800332, 0.797992, 0.795643, 0.793284, 
0.790916, 0.788537, 0.786150, 0.783753, 0.781346, 0.778931, 0.776507, 0.774074, 0.771631, 0.769180, 0.766720, 0.764252, 0.761775, 0.759289, 0.756796, 0.754294, 
0.751783, 0.749265, 0.746739, 0.744205, 0.741664, 0.739114, 0.736557, 0.733993, 0.731421, 0.728842, 0.726255, 0.723662, 0.721061, 0.718454, 0.715840, 0.713219, 
0.710592, 0.707958, 0.705318, 0.702671, 0.700019, 0.697360, 0.694695, 0.692024, 0.689348, 0.686665, 0.683977, 0.681284, 0.678585, 0.675882, 0.673172, 0.670458, 
0.667739, 0.665014, 0.662286, 0.659552, 0.656814, 0.654071, 0.651324, 0.648573, 0.645817, 0.643058, 0.640294, 0.637527, 0.634756, 0.631982, 0.629204, 0.626422, 
0.623637, 0.620849, 0.618057, 0.615263, 0.612466, 0.609666, 0.606863, 0.604058, 0.601250, 0.598440, 0.595628, 0.592813, 0.589997, 0.587178, 0.584358, 0.581536, 
0.578712, 0.575887, 0.573060, 0.570232, 0.567403, 0.564573, 0.561742, 0.558909, 0.556077, 0.553243, 0.550409, 0.547574, 0.544739, 0.541904, 0.539069, 0.536234, 
0.533398, 0.530563, 0.527728, 0.524894, 0.522060, 0.519227, 0.516394, 0.513563, 0.510732, 0.507902, 0.505073, 0.502246, 0.499420, 0.496595, 0.493773, 0.490951, 
0.488132, 0.485314, 0.482499, 0.479685, 0.476874, 0.474065, 0.471259, 0.468455, 0.465654, 0.462855, 0.460059, 0.457266, 0.454477, 0.451690, 0.448907, 0.446127, 
0.443350, 0.440578, 0.437808, 0.435043, 0.432282, 0.429524, 0.426771, 0.424022, 0.421277, 0.418536, 0.415801, 0.413069, 0.410343, 0.407621, 0.404904, 0.402192, 
0.399486, 0.396785, 0.394088, 0.391398, 0.388713, 0.386033, 0.383360, 0.380692, 0.378030, 0.375374, 0.372724, 0.370081, 0.367444, 0.364813, 0.362189, 0.359572, 
0.356961, 0.354357, 0.351760, 0.349170, 0.346588, 0.344012, 0.341444, 0.338883, 0.336330, 0.333785, 0.331247, 0.328717, 0.326195, 0.323680, 0.321174, 0.318676, 
0.316187, 0.313706, 0.311233, 0.308769, 0.306313, 0.303867, 0.301429, 0.299000, 0.296580, 0.294169, 0.291767, 0.289375, 0.286992, 0.284619, 0.282255, 0.279901, 
0.277556, 0.275222, 0.272897, 0.270582, 0.268278, 0.265984, 0.263699, 0.261426, 0.259163, 0.256910, 0.254668, 0.252436, 0.250216, 0.248006, 0.245807, 0.243619, 
0.241443, 0.239277, 0.237123, 0.234980, 0.232849, 0.230729, 0.228621, 0.226524, 0.224439, 0.222366, 0.220305, 0.218256, 0.216219, 0.214194, 0.212182, 0.210182, 
0.208194, 0.206218, 0.204255, 0.202305, 0.200368, 0.198443, 0.196530, 0.194631, 0.192745, 0.190872, 0.189012, 0.187165, 0.185331, 0.183511, 0.181704, 0.179911, 
0.178131, 0.176364, 0.174612, 0.172873, 0.171148, 0.169436, 0.167739, 0.166055, 0.164386, 0.162731, 0.161090, 0.159463, 0.157850, 0.156252, 0.154668, 0.153099, 
0.151544, 0.150004, 0.148478, 0.146967, 0.145471, 0.143990, 0.142523, 0.141072, 0.139636, 0.138214, 0.136808, 0.135416, 0.134040, 0.132680, 0.131334, 0.130004, 
0.128689, 0.127390, 0.126107, 0.124838, 0.123586, 0.122349, 0.121128, 0.119922, 0.118732, 0.117558, 0.116401, 0.115258, 0.114132, 0.113022, 0.111928, 0.110850, 
0.109788, 0.108743, 0.107713, 0.106700, 0.105703, 0.104722, 0.103758, 0.102810, 0.101878, 0.100963, 0.100065, 0.099183, 0.098318, 0.097469, 0.096637, 0.095821, 
0.095022, 0.094240, 0.093475, 0.092726, 0.091995, 0.091280, 0.090582, 0.089901, 0.089236, 0.088589, 0.087959, 0.087345, 0.086749, 0.086170, 0.085608, 0.085062, 
0.084534, 0.084023, 0.083530, 0.083053, 0.082594, 0.082151, 0.081726, 0.081318, 0.080928, 0.080555, 0.080199, 0.079860, 0.079538, 0.079234, 0.078947, 0.078678, 
0.078426, 0.078191, 0.077973, 0.077773, 0.077590, 0.077425, 0.077277, 0.077147, 0.077033, 0.076938, 0.076859, 0.076798, 0.076755, 0.076729, 0.076720, 
};

// create the filter bank matrix
float filter_bank[NUM_FILTERS * (FFT_SIZE / 2 + 1)];
// create the buffer to store the magnitude spectrum
float mag_spectrum[FFT_SIZE / 2 + 1];
arm_rfft_fast_instance_f32 audio_fft_instance;
arm_dct4_instance_f32 audio_dct_instance;
arm_rfft_instance_f32 audio_rfft_instance;
arm_cfft_radix4_instance_f32 audio_cfft_instance;
float mel_spectrum[NUM_FILTERS];

void audio_hamming_window(float* audio_src_ptr,uint32_t audio_len);
void create_mel_filter_bank(float* filter_bank,uint16_t num_filters,uint16_t low_freq,uint16_t high_freq,uint32_t sample_rate,uint16_t fft_size);
void audio_mel_filter(float *fft_src_ptr,uint32_t fft_len,float *mel_spectrum_ptr);
void audio_extract_mfcc(float *mel_spec_src_ptr,uint32_t mel_spec_len,float *mfcc_ptr,uint32_t mfcc_len);

/*************************************************************/
/*                        FUNCTION                           */
/*************************************************************/

void audio_get_mfcc(float* audio_src_ptr,float* audio_dst_ptr,float* mfcc_dst_ptr, uint32_t mfcc_len)
{
    memset(mel_spectrum, 0, sizeof(mel_spectrum));
    audio_hamming_window(audio_src_ptr, FRAME_SIZE);
    arm_rfft_fast_f32(&audio_fft_instance, audio_src_ptr, audio_dst_ptr, 0);
    audio_mel_filter(audio_dst_ptr, FRAME_SIZE, mel_spectrum);
    audio_extract_mfcc(mel_spectrum,NUM_FILTERS, mfcc_dst_ptr, mfcc_len);
}

void mfcc_init(void)
{
    create_mel_filter_bank(filter_bank, NUM_FILTERS, LOW_FREQ, HIGH_FREQ, SAMPLING_RATE, FFT_SIZE);
    arm_rfft_fast_init_f32(&audio_fft_instance, FRAME_SIZE);
    arm_cfft_radix4_init_f32(&audio_cfft_instance, 128, 0, 1);
    arm_rfft_init_f32(&audio_rfft_instance, &audio_cfft_instance, 128, 0, 1);
    /* 0.044194174 is sqrt(2/1024) in which 1024 stands for 1024 point DCT */
    if(arm_dct4_init_f32(&audio_dct_instance, &audio_rfft_instance, &audio_cfft_instance, 128, 128/2, 0.125)==ARM_MATH_ARGUMENT_ERROR)
    {
        while(1){}
    }
}

void audio_hamming_window(float* audio_src_ptr, uint32_t audio_len)
{
    for(uint16_t i = 0; i < audio_len; i++)
    {
        audio_src_ptr[i] *= hamming_window[i];
    }
}

// a function to create the mel filter bank matrix
void create_mel_filter_bank(float *filter_bank, uint16_t num_filters, uint16_t low_freq, uint16_t high_freq, uint32_t sample_rate, uint16_t fft_size)
{
  // convert the frequency limits to mel scale
  float mel_low = 2595 * log10(1 + (double)(low_freq) / 700);
  float mel_high = 2595 * log10(1 + (double)(high_freq) / 700);
  float mel_diff_cell = (mel_high - mel_low)/(NUM_FILTERS + 2);

  // create a vector of equally spaced mel values
  float mel_points[NUM_FILTERS + 2]={0};

  // arm_fill_f32(0, mel_points, NUM_FILTERS + 2);
  for(uint16_t i=0 ; i<NUM_FILTERS + 2 ; i++)
  {
	  mel_points[i] = mel_low + mel_diff_cell*i;
  }
//  arm_linspace_f32(mel_low, mel_high, mel_points, NUM_FILTERS + 2); // fill the vector with linearly spaced values

  // convert the mel values to frequency values
  float freq_points[NUM_FILTERS + 2];
  arm_fill_f32(0, freq_points, NUM_FILTERS + 2); // initialize the vector to zero
  for (int i = 0; i < NUM_FILTERS + 2; i++) {
    // apply the inverse mel formula
    freq_points[i] = 700 * (powf(10, mel_points[i] / 2595) - 1);
  }

  // convert the frequency values to FFT bin values
  int bin_points[NUM_FILTERS + 2];
  for (int i = 0; i < NUM_FILTERS + 2; i++) {
    // apply the bin formula and round to the nearest integer
    bin_points[i] = (int)roundf(((fft_size + 1) * freq_points[i]) / sample_rate);
  }

  // create the filter bank matrix
  for (int i = 0; i < num_filters; i++) {
    // get the start, center, and end bin of the current filter
    int start = bin_points[i];
    int center = bin_points[i + 1];
    int end = bin_points[i + 2];

    // fill the filter values for the current row
    for (int j = start; j < center; j++) {
      // compute the rising edge value
      filter_bank[i * (fft_size / 2 + 1) + j] = (float)(j - start) / (center - start);
    }
    for (int j = center; j < end; j++) {
      // compute the falling edge value
      filter_bank[i * (fft_size / 2 + 1) + j] = (float)(end - j) / (end - center);
    }
  }

  // normalize the filter coefficients by dividing each row by its sum
  for (int i = 0; i < num_filters; i++) 
  {
    // compute the sum of the current row
    float sum = 0;
    for(uint16_t j=0 ; j<fft_size / 2 + 1 ; j++)
    {
    	sum += filter_bank[i * (fft_size / 2 + 1) + j];
    }
    // divide each element by the sum
    arm_scale_f32(&filter_bank[i * (fft_size / 2 + 1)], 1 / sum, &filter_bank[i * (fft_size / 2 + 1)], fft_size / 2 + 1);
  }
}

/**
 * @brief a function to apply the mel filter bank to an audio slice
 * 
 * @param fft_src_ptr 
 * @param fft_len 
 * @param mel_spectrum_ptr 
 * 
 * @note size of mel_spectrum_ptr must be `NUM_FILTERS`
 */

void audio_mel_filter(float *fft_src_ptr, uint32_t fft_len,float *mel_spectrum_ptr)
{
    // compute the magnitude of the FFT output
    arm_cmplx_mag_f32(fft_src_ptr, mag_spectrum, FFT_SIZE / 2 + 1);

    arm_matrix_instance_f32 filter_bank_matrix = {NUM_FILTERS, FFT_SIZE / 2 + 1, filter_bank};
    arm_matrix_instance_f32 mag_spectrum_matrix = {FFT_SIZE / 2 + 1, 1, mag_spectrum};
    arm_matrix_instance_f32 mel_spectrum_matrix = {NUM_FILTERS, 1, mel_spectrum_ptr};

    // apply the filter bank to the magnitude spectrum
    arm_mat_mult_f32(&filter_bank_matrix, &mag_spectrum_matrix, &mel_spectrum_matrix);
}

/**
 * @brief a function to get the MFCC from an mel spectrum.
 * 
 * @param dct_src_ptr 
 * @param dct_len 
 * @param mfcc_ptr 
 * @param mfcc_len must <= `NUM_FILTERS`
 */
float mfcc[128];
float dct_tmp[256];
void audio_extract_mfcc(float *mel_spec_src_ptr,uint32_t mel_spec_len,float *mfcc_ptr,uint32_t mfcc_len)
{
    memset(mfcc, 0, sizeof(mfcc));
    memset(dct_tmp, 0, sizeof(dct_tmp));
    // apply the log function to the mel spectrum
    for(uint16_t i=0 ; i<NUM_FILTERS ; i++)
    {
    	mfcc[i] = log10f(mel_spec_src_ptr[i]);
    }
    arm_dct4_f32(&audio_dct_instance, dct_tmp, mfcc);
    // copy the desired number of MFCC to the output pointer
    arm_copy_f32(mfcc, mfcc_ptr, mfcc_len);
}